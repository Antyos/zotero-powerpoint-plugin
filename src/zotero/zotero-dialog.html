<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zotero PowerPoint Integration</title>

    <!-- Office JavaScript API -->
    <script
      type="text/javascript"
      src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"
    ></script>

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #d73027;
        margin-top: 0;
        font-size: 24px;
      }

      .status {
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        font-weight: bold;
      }

      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info-section {
        margin: 20px 0;
        padding: 15px;
        background-color: #e7f3ff;
        border-radius: 5px;
        border-left: 4px solid #0066cc;
      }

      .info-section h3 {
        margin-top: 0;
        color: #0066cc;
      }

      .settings-section {
        margin: 20px 0;
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .setting-row:last-child {
        border-bottom: none;
      }

      label {
        font-weight: 500;
        color: #333;
      }

      select {
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background-color: white;
      }

      button {
        background-color: #d73027;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }

      button:hover {
        background-color: #c02920;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .button-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
        gap: 10px;
      }

      .instructions {
        font-size: 14px;
        color: #666;
        line-height: 1.5;
      }

      .loading {
        display: none;
        text-align: center;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Zotero PowerPoint Integration</h1>

      <div id="connection-status" class="status disconnected">
        <div class="loading">Checking Zotero connection...</div>
        <div id="status-text">Checking connection to Zotero...</div>
      </div>

      <div class="info-section">
        <h3>How to Use</h3>
        <div class="instructions">
          <p><strong>1.</strong> Make sure Zotero is running on your computer</p>
          <p><strong>2.</strong> Install the <em>Better BibTeX</em> plugin in Zotero</p>
          <p><strong>3.</strong> Click "Insert Citation" in PowerPoint ribbon</p>
          <p><strong>4.</strong> Select items in the Zotero picker that opens</p>
          <p><strong>5.</strong> The formatted citation will be inserted into your slide</p>
        </div>
      </div>

      <div class="settings-section">
        <h3>Citation Settings</h3>

        <div class="setting-row">
          <label for="citation-style">Citation Style:</label>
          <select id="citation-style">
            <option value="apa">APA 7th Edition</option>
            <option value="mla">MLA 8th Edition</option>
            <option value="chicago-author-date">Chicago Author-Date</option>
            <option value="ieee">IEEE</option>
            <option value="vancouver">Vancouver</option>
          </select>
        </div>

        <div class="setting-row">
          <label for="citation-format">Format:</label>
          <select id="citation-format">
            <option value="formatted-citation">Formatted Citation</option>
            <option value="pandoc">Pandoc</option>
            <option value="latex">LaTeX</option>
            <option value="biblatex">BibLaTeX</option>
          </select>
        </div>

        <div class="setting-row">
          <label for="zotero-port">Zotero Port:</label>
          <select id="zotero-port">
            <option value="23119">23119 (Default)</option>
            <option value="23120">23120</option>
            <option value="23121">23121</option>
          </select>
        </div>
      </div>

      <div class="button-row">
        <button id="test-connection" onclick="testConnection()">Test Connection</button>
        <button id="close-dialog" onclick="closeDialog()">Close</button>
      </div>
    </div>

    <script>
      Office.onReady(function () {
        // Initialize dialog
        checkZoteroConnection();
        loadSettings();
      });

      async function checkZoteroConnection() {
        const statusDiv = document.getElementById("connection-status");
        const statusText = document.getElementById("status-text");
        const loading = statusDiv.querySelector(".loading");

        loading.style.display = "block";
        statusText.style.display = "none";

        try {
          const port = document.getElementById("zotero-port").value || "23119";
          const response = await fetch(`http://127.0.0.1:${port}/better-bibtex/cayw?probe=true`);

          if (response.ok) {
            const result = await response.text();
            if (result === "ready") {
              statusDiv.className = "status connected";
              statusText.textContent = "✓ Connected to Zotero with Better BibTeX";
            } else {
              statusDiv.className = "status disconnected";
              statusText.textContent = "✗ Zotero running but Better BibTeX not ready";
            }
          } else {
            statusDiv.className = "status disconnected";
            statusText.textContent = "✗ Cannot connect to Zotero";
          }
        } catch (error) {
          statusDiv.className = "status disconnected";
          statusText.textContent = "✗ Zotero is not running or Better BibTeX not installed";
        }

        loading.style.display = "none";
        statusText.style.display = "block";
      }

      function loadSettings() {
        // Load saved settings from Office settings
        try {
          const settings = Office.context.document.settings;

          const savedStyle = settings.get("zotero-citation-style") || "apa";
          const savedFormat = settings.get("zotero-citation-format") || "formatted-citation";
          const savedPort = settings.get("zotero-port") || "23119";

          document.getElementById("citation-style").value = savedStyle;
          document.getElementById("citation-format").value = savedFormat;
          document.getElementById("zotero-port").value = savedPort;
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      function saveSettings() {
        try {
          const settings = Office.context.document.settings;

          settings.set("zotero-citation-style", document.getElementById("citation-style").value);
          settings.set("zotero-citation-format", document.getElementById("citation-format").value);
          settings.set("zotero-port", document.getElementById("zotero-port").value);

          settings.saveAsync();
        } catch (error) {
          console.error("Error saving settings:", error);
        }
      }

      function testConnection() {
        saveSettings();
        checkZoteroConnection();
      }

      function closeDialog() {
        saveSettings();

        // Send message to parent with settings
        const settings = {
          style: document.getElementById("citation-style").value,
          format: document.getElementById("citation-format").value,
          port: document.getElementById("zotero-port").value,
        };

        try {
          Office.context.ui.messageParent(
            JSON.stringify({
              type: "settings-updated",
              settings: settings,
            })
          );
        } catch (error) {
          // Fallback: just close the dialog
          window.close();
        }
      }

      // Auto-save settings when changed
      document.getElementById("citation-style").addEventListener("change", saveSettings);
      document.getElementById("citation-format").addEventListener("change", saveSettings);
      document.getElementById("zotero-port").addEventListener("change", function () {
        saveSettings();
        checkZoteroConnection(); // Re-test connection with new port
      });
    </script>
  </body>
</html>
